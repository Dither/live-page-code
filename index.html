<!DOCTYPE html>
<html><head>
<title>Save Page Snapshot</title>
<script>
window.addEventListener('load', function () {
function s2b(s) { return s ===  'true' ? true : false; }

if (typeof widget === 'undefined' || !widget.preferences) {
    storage = window.opera.scriptStorage
} else {
    storage = widget.preferences;
}

var tab, saveimg, encb64;
opera.extension.onmessage = function (e) {
    switch (e.data.type) {
    case 'got-url':
        if (tab) opera.extension.tabs.update(tab, { url: e.data.url, focused: true });
        break;
    }
}

var button = opera.contexts.toolbar.createItem({
    disabled: false,
    title: 'Save page snapshot',
    icon: 'icons/icon16.png',
    onclick: function () {
        try { tab = opera.extension.tabs.getFocused(); } catch (e) {;}
        if (tab) opera.extension.broadcastMessage({
            type: 'save-snapshot-encode',
            url: tab.url,
            images: s2b(storage['saveimages']) || false,
            b64: s2b(storage['encodeb64']) || true,
            debug: s2b(storage['debugmode']) || false,
        });
    }
});

opera.contexts.toolbar.addItem(button);
button.disabled = true;

function enableButton() { if (opera.extension.tabs.getFocused()) { button.disabled = false; } else { button.disabled = true; } }

// Enable the button when a tab is ready
opera.extension.onconnect = enableButton;
opera.extension.tabs.onfocus = enableButton;
opera.extension.tabs.onblur = enableButton;

}, false);
</script>
</head>
</html>
