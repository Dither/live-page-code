<!DOCTYPE html><html><head><title>Live Page Code [background]</title>
<script>
window.addEventListener('load', function () {
if (typeof widget === 'undefined' || !widget.preferences) { storage = window.opera.scriptStorage; }
else { storage = widget.preferences; }

function s2b(s) { return s ===  'true' ? true : false; }
function log(){ if (s2b(storage['debugmode'])) opera.postError('[LivePageCode]: ' + Array.prototype.slice.call(arguments)); }

var tab;
opera.extension.onmessage = function (e) {
    if (e.data.type == 'got-url') {
        try { tab = opera.extension.tabs.getFocused(); } catch (e) {log('active tab not found.');}
    	if (tab) log('initiating save dialog...');
        if (tab) opera.extension.tabs.update(tab, { url: e.data.url, focused: true });
    }
}

var button = opera.contexts.toolbar.createItem({
    disabled: true,
    title: 'Save live page code',
    icon: 'icons/icon16.gif',
    onclick: function () {
        log('toolbar button clicked.');
        try { tab = opera.extension.tabs.getFocused(); } catch (e) {log('active tab not found.');}
        if (tab) tab.postMessage({
            type: 'save-snapshot',
            url: tab.url,
            images: s2b(storage['saveimages']) || false,
            b64: s2b(storage['encodeb64']) || true,
            debug: s2b(storage['debugmode']) || false,
        });
    }
});

opera.contexts.toolbar.addItem(button);

function enableButton() { if (opera.extension.tabs.getFocused()) { button.disabled = false; } else { button.disabled = true; } }

// Enable the button when a tab is ready
opera.extension.onconnect = enableButton;
opera.extension.tabs.onfocus = enableButton;
opera.extension.tabs.onblur = enableButton;

}, false);
</script>
</head>
</html>
